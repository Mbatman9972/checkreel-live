<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CheckReel Dashboard</title>
<link rel="icon" type="image/x-icon" href="images/favicon.ico">
<!-- Commented out to prevent 401 error -->
<!-- <link rel="manifest" href="manifest.json"> -->
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
background: linear-gradient(135deg, #1e3c72 0%, #2a5298 25%, #667eea 50%, #764ba2 75%, #8e44ad 100%);
min-height: 100vh;
color: #333;
}

body[dir="rtl"] {
    direction: rtl;
}

body[dir="rtl"] .container {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

body[dir="rtl"] .card {
    display: block !important;
    visibility: visible !important;
}

.container {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
}

/* Header */
.header {
display: flex;
justify-content: space-between;
align-items: center;
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
padding: 15px 30px;
border-radius: 15px;
margin-bottom: 30px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.logo-section {
display: flex;
align-items: center;
gap: 15px;
}

.logo-img {
width: 45px;
height: 45px;
border-radius: 10px;
}

.logo-text {
font-size: 24px;
font-weight: bold;
background: linear-gradient(45deg, #1e3c72, #667eea);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

.user-section {
display: flex;
align-items: center;
gap: 20px;
}

.tier-badge {
padding: 8px 16px;
border-radius: 20px;
font-size: 12px;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.5px;
}

.tier-free { background: #e3f2fd; color: #1976d2; }
.tier-plus { background: #f3e5f5; color: #7b1fa2; }
.tier-premium { background: #fff3e0; color: #f57c00; }

/* Main Content */
.dashboard-grid {
display: grid;
grid-template-columns: 1fr 1fr 1fr;
gap: 20px;
margin-bottom: 30px;
}

.card {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 20px;
padding: 25px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.card h2 {
margin-bottom: 20px;
color: #333;
display: flex;
align-items: center;
gap: 10px;
font-size: 18px;
}

/* Region Selection */
.region-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 10px;
margin-bottom: 15px;
}

.region-option {
display: flex;
flex-direction: column;
align-items: center;
padding: 15px;
border: 2px solid #e0e0e0;
border-radius: 12px;
cursor: pointer;
transition: all 0.3s ease;
background: white;
text-align: center;
}

.region-option:hover {
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.region-option.selected {
border-color: #1e3c72;
background: linear-gradient(135deg, #1e3c72 0%, #667eea 100%);
color: white;
animation: glowPulse 2s infinite ease-in-out;
}

@keyframes glowPulse {
0%, 100% {
box-shadow: 0 0 20px rgba(30, 60, 114, 0.7);
}
50% {
box-shadow: 0 0 30px rgba(30, 60, 114, 1), 0 0 40px rgba(102, 126, 234, 0.8);
}
}

.region-icon {
width: 35px;
height: 35px;
margin-bottom: 8px;
border-radius: 6px;
object-fit: cover;
}

.region-name {
font-size: 12px;
font-weight: 600;
}

/* Platform Selection */
.platforms-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 12px;
}

.platform-option {
display: flex;
flex-direction: column;
align-items: center;
padding: 15px;
border: 2px solid #e0e0e0;
border-radius: 12px;
cursor: pointer;
transition: all 0.3s ease;
background: white;
position: relative;
overflow: hidden;
}

.platform-option:hover {
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.platform-option.selected {
border-color: #ff1493;
background: linear-gradient(135deg, #ff1493 0%, #ff69b4 100%);
color: white;
animation: pinkGlow 2s infinite ease-in-out;
}

@keyframes pinkGlow {
0%, 100% {
box-shadow: 0 0 20px rgba(255, 20, 147, 0.7);
}
50% {
box-shadow: 0 0 30px rgba(255, 20, 147, 1), 0 0 40px rgba(255, 105, 180, 0.8);
}
}

.platform-icon {
width: 35px;
height: 35px;
margin-bottom: 8px;
border-radius: 6px;
object-fit: cover;
transition: all 0.3s ease;
opacity: 1;
}

.platform-option.selected .platform-icon {
opacity: 1;
filter: brightness(1.2) contrast(1.1);
}

.platform-name {
font-size: 11px;
font-weight: 600;
text-align: center;
}

/* File Upload */
.upload-area {
border: 3px dashed #ddd;
border-radius: 15px;
padding: 30px;
text-align: center;
cursor: pointer;
transition: all 0.3s ease;
background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.upload-area:hover {
border-color: #1e3c72;
background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
}

.upload-area.dragover {
border-color: #1e3c72;
background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
transform: scale(1.02);
}

.upload-icon {
font-size: 36px;
margin-bottom: 10px;
display: block;
}

.file-info {
display: none;
text-align: center;
padding: 20px;
background: #f8f9fa;
border-radius: 10px;
border: 2px solid #28a745;
}

.file-name {
font-weight: 600;
margin-bottom: 5px;
}

.remove-file {
background: #dc3545;
color: white;
border: none;
padding: 8px 16px;
border-radius: 5px;
cursor: pointer;
margin-top: 10px;
}

/* Tier Selection */
.tier-selection {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 20px;
padding: 25px;
margin-bottom: 20px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.tier-plans {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 15px;
margin-top: 15px;
}

.tier-plan {
background: white;
border: 2px solid #e0e0e0;
border-radius: 15px;
padding: 20px;
text-align: center;
cursor: pointer;
transition: all 0.3s ease;
position: relative;
}

.tier-plan:hover {
transform: translateY(-3px);
box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.tier-plan.active {
border-color: #1e3c72;
background: linear-gradient(135deg, #1e3c72 0%, #667eea 100%);
color: white;
}

.tier-plan.recommended {
border-color: #ff6b6b;
}

.tier-plan.recommended::before {
content: "RECOMMENDED";
position: absolute;
top: -10px;
left: 50%;
transform: translateX(-50%);
background: #ff6b6b;
color: white;
padding: 4px 12px;
border-radius: 12px;
font-size: 10px;
font-weight: bold;
}

.tier-name {
font-size: 16px;
font-weight: bold;
margin-bottom: 8px;
}

.tier-price {
font-size: 18px;
font-weight: bold;
color: #1e3c72;
margin-bottom: 8px;
}

.tier-plan.active .tier-price {
color: white;
}

.tier-scans {
font-size: 12px;
opacity: 0.8;
margin-bottom: 10px;
}

.tier-features {
font-size: 11px;
opacity: 0.9;
line-height: 1.4;
}

/* Selection Alert - Moved below tier selection */
.selection-alert {
background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
color: white;
padding: 15px 25px;
border-radius: 10px;
margin-bottom: 20px;
text-align: center;
font-weight: 600;
box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
}

.selection-alert.hidden {
display: none;
}

/* Scan Button */
.scan-section {
text-align: center;
margin-top: 30px;
position: relative;
z-index: 10;
}

.scan-btn {
background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
color: white;
border: none;
padding: 15px 40px;
border-radius: 25px;
font-size: 18px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
display: inline-flex;
align-items: center;
gap: 10px;
min-width: 200px;
justify-content: center;
position: relative;
}

.scan-btn:disabled {
background: #ccc;
cursor: not-allowed;
}

.scan-btn.ready {
background: linear-gradient(135deg, #1e3c72 0%, #667eea 100%);
box-shadow: 0 8px 25px rgba(30, 60, 114, 0.3);
}

.scan-btn.ready:hover {
transform: translateY(-2px);
box-shadow: 0 12px 35px rgba(30, 60, 114, 0.4);
}

.btn-loader {
display: none;
width: 20px;
height: 20px;
border: 2px solid transparent;
border-top: 2px solid white;
border-radius: 50%;
animation: spin 1s linear infinite;
}

.btn-loader.active {
display: block;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* Scan History */
.scan-history {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
border-radius: 20px;
padding: 25px;
margin-top: 50px;
margin-bottom: 30px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
display: none;
}

.scan-history.visible {
display: block;
}

.history-tabs {
display: flex;
gap: 10px;
margin-bottom: 20px;
border-bottom: 2px solid #e0e0e0;
}

.history-tab {
padding: 10px 20px;
background: none;
border: none;
cursor: pointer;
font-weight: 600;
color: #666;
transition: all 0.3s ease;
border-bottom: 3px solid transparent;
}

.history-tab.active {
color: #1e3c72;
border-bottom-color: #1e3c72;
}

.history-list {
max-height: 300px;
overflow-y: auto;
}

.history-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 15px;
background: #f8f9fa;
border-radius: 10px;
margin-bottom: 10px;
cursor: pointer;
transition: all 0.3s ease;
}

.history-item:hover {
background: #e3f2fd;
transform: translateX(5px);
}

.history-date {
font-size: 12px;
color: #666;
}

/* Countries Modal */
.countries-modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.8);
z-index: 1000;
padding: 20px;
}

.countries-content {
background: white;
border-radius: 20px;
padding: 30px;
max-width: 600px;
max-height: 80vh;
margin: 50px auto;
overflow-y: auto;
position: relative;
}

.close-modal {
position: absolute;
top: 15px;
right: 20px;
background: none;
border: none;
font-size: 24px;
cursor: pointer;
color: #666;
}

.countries-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
gap: 10px;
margin-top: 20px;
}

.country-item {
padding: 10px;
background: #f8f9fa;
border-radius: 8px;
text-align: center;
cursor: pointer;
transition: all 0.3s ease;
border: 2px solid transparent;
}

.country-item:hover {
background: #e3f2fd;
border-color: #1e3c72;
}

/* Results Section */
.results-section {
display: none;
margin-top: 30px;
}

.score-display {
display: flex;
align-items: center;
justify-content: center;
gap: 30px;
margin-bottom: 30px;
}

.score-circle {
width: 120px;
height: 120px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
position: relative;
box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.score-circle::before {
content: '';
width: 80px;
height: 80px;
background: white;
border-radius: 50%;
position: absolute;
}

.score-value {
font-size: 24px;
font-weight: bold;
z-index: 1;
color: #333;
}

.status-indicator {
display: flex;
align-items: center;
gap: 10px;
font-size: 18px;
font-weight: 600;
}

.status-icon {
font-size: 24px;
}

.results-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
}

.issues-card, .recommendations-card {
background: white;
padding: 20px;
border-radius: 15px;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.issue-item, .recommendation-item {
display: flex;
align-items: center;
gap: 10px;
padding: 10px;
margin-bottom: 10px;
background: #f8f9fa;
border-radius: 8px;
cursor: pointer;
transition: all 0.3s ease;
}

.issue-item:hover, .recommendation-item:hover {
background: #e3f2fd;
transform: translateX(5px);
}

/* Insight Modal */
.insight-modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.8);
z-index: 1000;
padding: 20px;
}

.insight-content {
background: white;
border-radius: 20px;
padding: 30px;
max-width: 500px;
margin: 50px auto;
position: relative;
}

.insight-content h3 {
margin-bottom: 20px;
color: #1e3c72;
}

/* Stats */
.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 15px;
margin-bottom: 20px;
}

.stat-card {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
padding: 15px;
border-radius: 15px;
text-align: center;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.stat-number {
font-size: 20px;
font-weight: bold;
color: #1e3c72;
margin-bottom: 5px;
}

.stat-label {
color: #666;
font-size: 12px;
}

/* Footer */
.footer {
text-align: center;
padding: 20px 0;
color: rgba(255, 255, 255, 0.8);
font-size: 14px;
margin-top: 40px;
}

/* Responsive */
@media (max-width: 1024px) {
.dashboard-grid {
grid-template-columns: 1fr 1fr;
}
}

@media (max-width: 768px) {
.dashboard-grid {
grid-template-columns: 1fr;
}
.platforms-grid {
grid-template-columns: repeat(2, 1fr);
}
.region-grid {
grid-template-columns: 1fr;
}
.tier-plans {
grid-template-columns: 1fr;
}
.score-display {
flex-direction: column;
gap: 20px;
}
}
</style>
</head>
<body>
<div class="container">
<!-- Header -->
<div class="header">
<div class="logo-section">
<img src="images/logo.png" alt="CheckReel Logo" class="logo-img">
<span class="logo-text">CheckReel</span>
</div>
<div class="user-section">
<span id="scansLeft">3 scans left</span>
<span id="tierBadge" class="tier-badge tier-free">Free Trial</span>
</div>
</div>

<!-- Tier Selection -->
<div class="tier-selection">
<h2 id="choose-plan">Choose Your Plan</h2>
<div class="tier-plans">
<div class="tier-plan active" data-tier="free" onclick="selectTier('free')">
<div class="tier-name" id="free-trial">Free Trial</div>
<div class="tier-price">$0</div>
<div class="tier-scans" id="free-scans">3 scans</div>
<div class="tier-features" id="free-features">Basic compliance check<br>Standard results</div>
</div>
<div class="tier-plan recommended" data-tier="plus" onclick="selectTier('plus')">
<div class="tier-name" id="plus-tier">Plus</div>
<div class="tier-price">$4.99/<span id="per-month">mo</span></div>
<div class="tier-scans" id="plus-scans">20 scans/month</div>
<div class="tier-features" id="plus-features">Enhanced compliance check<br>Detailed insights<br>Scan history<br>Priority support</div>
</div>
<div class="tier-plan" data-tier="premium" onclick="selectTier('premium')">
<div class="tier-name" id="premium-tier">Premium</div>
<div class="tier-price">$9.99/<span id="per-month-premium">mo</span></div>
<div class="tier-scans" id="premium-scans">40 scans/month</div>
<div class="tier-features" id="premium-features">Full compliance suite<br>Advanced analytics<br>Team features<br>White-label reports<br>API access<br>Dedicated support</div>
</div>
</div>
</div>

<!-- Selection Alert -->
<div id="selectionAlert" class="selection-alert">
<span id="selection-alert">Please select a region and platform before uploading content for analysis</span>
</div>

<!-- Main Dashboard -->
<div class="dashboard-grid">
<!-- Region Selection -->
<div class="card">
<h2 id="select-region">Select Region</h2>
<div class="region-grid">
<div class="region-option" data-region="global" onclick="selectRegion('global')">
<img src="images/region-icons/global.png" alt="Global" class="region-icon"
onerror="this.outerHTML='<div style=&quot;width: 35px; height: 35px; background: #3498db; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;&quot;>🌍</div>';">
<span class="region-name">Global</span>
</div>
<div class="region-option" data-region="middle-east" onclick="selectRegion('middle-east'); showCountries('middleEast')">
<img src="images/region-icons/middle-east.png" alt="Middle East" class="region-icon"
onerror="this.outerHTML='<div style=&quot;width: 35px; height: 35px; background: #e74c3c; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px;&quot;>ME</div>';">
<span class="region-name">Middle East</span>
</div>
<div class="region-option" data-region="mena" onclick="selectRegion('mena'); showCountries('mena')">
<img src="images/region-icons/mena.png" alt="MENA" class="region-icon"
onerror="this.outerHTML='<div style=&quot;width: 35px; height: 35px; background: #f39c12; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px;&quot;>MENA</div>';">
<span class="region-name">MENA</span>
</div>
<div class="region-option" data-region="europe" onclick="selectRegion('europe'); showCountries('europe')">
<img src="images/region-icons/europe.png" alt="Europe" class="region-icon"
onerror="this.outerHTML='<div style=&quot;width: 35px; height: 35px; background: #9b59b6; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;&quot;>EU</div>';">
<span class="region-name">Europe</span>
</div>
</div>
</div>

<!-- Platform Selection -->
<div class="card">
<h2 id="select-platform">Select Target Platform <span id="platformCounter" style="font-size: 12px; color: #666;"></span></h2>
<div class="platforms-grid">
<div class="platform-option" data-platform="tiktok" onclick="selectPlatform('tiktok')">
<img src="images/tiktok.png" alt="TikTok" class="platform-icon">
<span class="platform-name">TikTok</span>
</div>
<div class="platform-option" data-platform="youtube" onclick="selectPlatform('youtube')">
<img src="images/youtube.png" alt="YouTube" class="platform-icon">
<span class="platform-name">YouTube</span>
</div>
<div class="platform-option" data-platform="instagram" onclick="selectPlatform('instagram')">
<img src="images/instagram.png" alt="Instagram" class="platform-icon">
<span class="platform-name">Instagram</span>
</div>
<div class="platform-option" data-platform="facebook" onclick="selectPlatform('facebook')">
<img src="images/facebook.png" alt="Facebook" class="platform-icon">
<span class="platform-name">Facebook</span>
</div>
<div class="platform-option" data-platform="twitter" onclick="selectPlatform('twitter')">
<img src="images/twitter.png" alt="Twitter" class="platform-icon">
<span class="platform-name">Twitter</span>
</div>
<div class="platform-option" data-platform="snapchat" onclick="selectPlatform('snapchat')">
<img src="images/snapchat.png" alt="Snapchat" class="platform-icon">
<span class="platform-name">Snapchat</span>
</div>
</div>
</div>

<!-- File Upload -->
<div class="card">
<h2 id="upload-content">Upload Content to Check</h2>
<div id="uploadArea" class="upload-area">
<span class="upload-icon">📁</span>
<h3 id="drop-here">Drop your content here</h3>
<p id="click-browse">or click to browse files</p>
<small>Supports: MP4, MOV, JPG, PNG, MP3, WAV (max 100MB)</small>
</div>
<div id="fileInfo" class="file-info">
<div class="file-name" id="fileName"></div>
<div class="file-size" id="fileSize"></div>
<button id="removeFile" class="remove-file">Remove File</button>
</div>
<input type="file" id="fileInput" style="display: none;" accept="video/*,image/*,audio/*">
</div>
</div>

<!-- Scan Button -->
<div class="scan-section">
<button id="scanBtn" class="scan-btn" disabled>
<span id="start-check">Start Content Check</span>
<div id="btnLoader" class="btn-loader"></div>
</button>
</div>

<!-- Scan History -->
<div id="scanHistory" class="scan-history">
<h2 id="scan-history-title">Scan History</h2>
<div class="history-tabs">
<button class="history-tab active" onclick="filterHistory('all')" id="all-scans">All Scans</button>
<button class="history-tab" onclick="filterHistory('region')" id="by-region">By Region</button>
<button class="history-tab" onclick="filterHistory('platform')" id="by-platform">By Platform</button>
</div>
<div id="historyList" class="history-list"></div>
</div>

<!-- Results Section -->
<div id="resultsSection" class="results-section">
<div class="card">
<h2 id="compliance-report">Compliance Report</h2>
<div class="score-display">
<div id="scoreCircle" class="score-circle">
<span id="scoreValue" class="score-value">85</span>
</div>
<div class="status-indicator">
<span id="statusIcon" class="status-icon">✅</span>
<span id="status-text">Ready to Post</span>
</div>
</div>
<div class="results-grid">
<div class="issues-card">
<h3 id="issues-found">Issues Found</h3>
<div id="issuesList"></div>
</div>
<div class="recommendations-card">
<h3 id="recommendations">Recommendations</h3>
<div id="recommendationsList"></div>
</div>
</div>
</div>
</div>

<!-- Stats -->
<div class="stats-grid">
<div class="stat-card">
<div class="stat-number">2,697+</div>
<div class="stat-label" id="active-users">Active Users</div>
</div>
<div class="stat-card">
<div class="stat-number">15,847</div>
<div class="stat-label" id="content-scanned">Content Scanned</div>
</div>
<div class="stat-card">
<div class="stat-number">94%</div>
<div class="stat-label" id="success-rate">Success Rate</div>
</div>
<div class="stat-card">
<div class="stat-number">6</div>
<div class="stat-label" id="platforms">Platforms</div>
</div>
<div class="stat-card">
<div class="stat-number" id="scansUsedCounter">0</div>
<div class="stat-label" id="scans-used">Scans Used (Testing)</div>
</div>
</div>

<!-- Countries Modal -->
<div id="countriesModal" class="countries-modal">
<div class="countries-content">
<button class="close-modal" onclick="closeCountriesModal()">&times;</button>
<h2 id="modalTitle">Select Country</h2>
<div id="countriesGrid" class="countries-grid"></div>
</div>
</div>

<!-- Insight Modal -->
<div id="insightModal" class="insight-modal">
<div class="insight-content">
<button class="close-modal" onclick="closeInsightModal()">&times;</button>
<h3 id="insightTitle">Insight Details</h3>
<div id="insightContent"></div>
</div>
</div>

<!-- Footer -->
<div class="footer">
<p>&copy; 2025 CheckReel. All rights reserved. Copyright Protected.</p>
</div>
</div>

<!-- IMPORTANT: Load lang-loader.js FIRST -->
<script src="lang-loader.js"></script>

<!-- Main Dashboard Script -->
<script>
// Global variables
let selectedFile = null;
let selectedPlatforms = [];
let selectedRegion = null;
let selectedCountry = null;
let currentTier = 'free';
let scanHistory = [];
let currentLanguage = 'en';

// Safe storage wrapper
if (!window.safeStorage) {
  window.safeStorage = {
    getItem:   (k)=>{ try { return localStorage.getItem(k); } catch { return null } },
    setItem:   (k,v)=>{ try { localStorage.setItem(k,v) } catch {} },
    removeItem:(k)=>{ try { localStorage.removeItem(k) } catch {} }
  };
}

// Language content for dashboard elements
const DASHBOARD_TRANSLATIONS = {
    en: {
        'choose-plan': 'Choose Your Plan',
        'free-trial': 'Free Trial',
        'plus-tier': 'Plus',
        'premium-tier': 'Premium',
        'per-month': 'mo',
        'free-scans': '3 scans',
        'plus-scans': '20 scans/month',
        'premium-scans': '40 scans/month',
        'free-features': 'Basic compliance check<br>Standard results',
        'plus-features': 'Enhanced compliance check<br>Detailed insights<br>Scan history<br>Priority support',
        'premium-features': 'Full compliance suite<br>Advanced analytics<br>Team features<br>White-label reports<br>API access<br>Dedicated support',
        'selection-alert': 'Please select a region and platform before uploading content for analysis',
        'select-region': 'Select Region',
        'select-platform': 'Select Target Platform',
        'upload-content': 'Upload Content to Check',
        'drop-here': 'Drop your content here',
        'click-browse': 'or click to browse files',
        'start-check': 'Start Content Check',
        'analyzing': 'Analyzing...',
        'scan-history-title': 'Scan History',
        'all-scans': 'All Scans',
        'by-region': 'By Region',
        'by-platform': 'By Platform',
        'compliance-report': 'Compliance Report',
        'issues-found': 'Issues Found',
        'recommendations': 'Recommendations',
        'active-users': 'Active Users',
        'content-scanned': 'Content Scanned',
        'success-rate': 'Success Rate',
        'platforms': 'Platforms',
        'scans-used': 'Scans Used (Testing)',
        'scans-left': 'scans left',
        'recommended': 'RECOMMENDED'
    },
    fr: {
        'choose-plan': 'Choisissez votre plan',
        'free-trial': 'Essai gratuit',
        'plus-tier': 'Plus',
        'premium-tier': 'Premium',
        'per-month': 'mois',
        'free-scans': '3 analyses',
        'plus-scans': '20 analyses/mois',
        'premium-scans': '40 analyses/mois',
        'free-features': 'Vérification de conformité de base<br>Résultats standards',
        'plus-features': 'Vérification de conformité améliorée<br>Informations détaillées<br>Historique des analyses<br>Support prioritaire',
        'premium-features': 'Suite de conformité complète<br>Analyses avancées<br>Fonctionnalités d\'équipe<br>Rapports en marque blanche<br>Accès API<br>Support dédié',
        'selection-alert': 'Veuillez sélectionner une région et une plateforme avant de télécharger le contenu pour analyse',
        'select-region': 'Sélectionner la région',
        'select-platform': 'Sélectionner la plateforme cible',
        'upload-content': 'Télécharger le contenu à vérifier',
        'drop-here': 'Déposez votre contenu ici',
        'click-browse': 'ou cliquez pour parcourir les fichiers',
        'start-check': 'Commencer la vérification du contenu',
        'analyzing': 'Analyse en cours...',
        'scan-history-title': 'Historique des analyses',
        'all-scans': 'Toutes les analyses',
        'by-region': 'Par région',
        'by-platform': 'Par plateforme',
        'compliance-report': 'Rapport de conformité',
        'issues-found': 'Problèmes trouvés',
        'recommendations': 'Recommandations',
        'active-users': 'Utilisateurs actifs',
        'content-scanned': 'Contenu analysé',
        'success-rate': 'Taux de réussite',
        'platforms': 'Plateformes',
        'scans-used': 'Analyses utilisées (Test)',
        'scans-left': 'analyses restantes',
        'recommended': 'RECOMMANDÉ'
    },
    ar: {
        'choose-plan': 'اختر خطتك',
        'free-trial': 'تجربة مجانية',
        'plus-tier': 'بلس',
        'premium-tier': 'بريميوم',
        'per-month': 'شهر',
        'free-scans': '3 فحوصات',
        'plus-scans': '20 فحص/شهر',
        'premium-scans': '40 فحص/شهر',
        'free-features': 'فحص امتثال أساسي<br>نتائج قياسية',
        'plus-features': 'فحص امتثال محسّن<br>رؤى مفصلة<br>سجل الفحوصات<br>دعم ذو أولوية',
        'premium-features': 'مجموعة امتثال كاملة<br>تحليلات متقدمة<br>ميزات الفريق<br>تقارير بعلامة تجارية خاصة<br>الوصول إلى API<br>دعم مخصص',
        'selection-alert': 'يرجى اختيار منطقة ومنصة قبل تحميل المحتوى للتحليل',
        'select-region': 'اختر المنطقة',
        'select-platform': 'اختر المنصة المستهدفة',
        'upload-content': 'ارفع المحتوى للفحص',
        'drop-here': 'اسقط محتواك هنا',
        'click-browse': 'أو انقر لاستعراض الملفات',
        'start-check': 'ابدأ فحص المحتوى',
        'analyzing': 'جاري التحليل...',
        'scan-history-title': 'سجل الفحوصات',
        'all-scans': 'جميع الفحوصات',
        'by-region': 'حسب المنطقة',
        'by-platform': 'حسب المنصة',
        'compliance-report': 'تقرير الامتثال',
        'issues-found': 'المشاكل المكتشفة',
        'recommendations': 'التوصيات',
        'active-users': 'المستخدمون النشطون',
        'content-scanned': 'المحتوى المفحوص',
        'success-rate': 'معدل النجاح',
        'platforms': 'المنصات',
        'scans-used': 'الفحوصات المستخدمة (اختبار)',
        'scans-left': 'فحوصات متبقية',
        'recommended': 'موصى به'
    }
};

// Apply dashboard translations
function applyDashboardTranslations(lang) {
    const translations = DASHBOARD_TRANSLATIONS[lang] || DASHBOARD_TRANSLATIONS['en'];
    
    // Apply translations to all elements with IDs
    Object.keys(translations).forEach(key => {
        const element = document.getElementById(key);
        if (element) {
            if (key.includes('features')) {
                element.innerHTML = translations[key]; // Use innerHTML for line breaks
            } else {
                element.textContent = translations[key];
            }
        }
    });
    
    // Update "recommended" badge for Plus tier
    const plusTier = document.querySelector('[data-tier="plus"]');
    if (plusTier && translations['recommended']) {
        plusTier.querySelector('::before') || (plusTier.style.setProperty('--recommended-text', `"${translations['recommended']}"`));
    }
    
    // Update scans left display
    updateTierDisplay();
}

// Initialize dashboard with language persistence
document.addEventListener('DOMContentLoaded', function() {
    // Get current language from localStorage (set by index.html)
    currentLanguage = safeStorage.getItem('checkreel_language') || 'en';
    console.log('Dashboard loading with language:', currentLanguage);
    
    // Load language content from lang-loader.js first
    if (window.loadLanguageContent) {
        window.loadLanguageContent(currentLanguage);
    }
    
    // Apply dashboard-specific translations
    setTimeout(() => {
        applyDashboardTranslations(currentLanguage);
        
        // Set RTL for Arabic
        if (currentLanguage === 'ar') {
            document.body.setAttribute('dir', 'rtl');
            document.documentElement.setAttribute('dir', 'rtl');
        } else {
            document.body.removeAttribute('dir');
            document.documentElement.removeAttribute('dir');
        }
    }, 100);
    
    // Initialize dashboard functionality
    initializeUpload();
    updateTierDisplay();
    updateUserCounter();
    updateScansCounter();
    loadScanHistory();
    
    console.log('✅ Dashboard loaded with full language support');
});

// Countries data
const countriesData = {
    middleEast: [
        'Palestine', 'Jordan', 'Lebanon', 'Syria', 'Iraq', 'Kuwait', 'Saudi Arabia',
        'Bahrain', 'Qatar', 'United Arab Emirates', 'Oman', 'Yemen', 'Iran', 'Turkey', 'Cyprus'
    ],
    mena: [
        'Palestine', 'Jordan', 'Lebanon', 'Syria', 'Iraq', 'Kuwait', 'Saudi Arabia',
        'Bahrain', 'Qatar', 'United Arab Emirates', 'Oman', 'Yemen', 'Iran', 'Turkey',
        'Egypt', 'Libya', 'Tunisia', 'Algeria', 'Morocco', 'Sudan', 'Mauritania', 'Djibouti', 'Somalia'
    ],
    europe: [
        'Albania', 'Andorra', 'Armenia', 'Austria', 'Azerbaijan', 'Belarus', 'Belgium',
        'Bosnia and Herzegovina', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic',
        'Denmark', 'Estonia', 'Finland', 'France', 'Georgia', 'Germany', 'Greece',
        'Hungary', 'Iceland', 'Ireland', 'Italy', 'Kazakhstan', 'Kosovo', 'Latvia',
        'Liechtenstein', 'Lithuania', 'Luxembourg', 'Malta', 'Moldova', 'Monaco',
        'Montenegro', 'Netherlands', 'North Macedonia', 'Norway', 'Poland', 'Portugal',
        'Romania', 'Russia', 'San Marino', 'Serbia', 'Slovakia', 'Slovenia', 'Spain',
        'Sweden', 'Switzerland', 'Ukraine', 'United Kingdom', 'Vatican City'
    ]
};

// Tier selection
function selectTier(tier) {
    currentTier = tier;
    safeStorage.setItem('checkreel_tier', tier);
    
    // Update visual selection
    document.querySelectorAll('.tier-plan').forEach(plan => {
        plan.classList.remove('active');
    });
    document.querySelector(`[data-tier="${tier}"]`).classList.add('active');
    
    // Reset scans if upgrading
    if (tier !== 'free') {
        safeStorage.setItem('checkreel_scans_used', '0');
    }
    
    updateTierDisplay();
    updateScansCounter();
    updatePlatformCounter();
    
    // Show/hide scan history
    const historySection = document.getElementById('scanHistory');
    if (tier === 'plus' || tier === 'premium') {
        historySection.classList.add('visible');
    } else {
        historySection.classList.remove('visible');
    }
}

// Region selection
function selectRegion(region) {
    selectedRegion = region;
    document.querySelectorAll('.region-option').forEach(opt => opt.classList.remove('selected'));
    document.querySelector(`[data-region="${region}"]`).classList.add('selected');
    updateScanButton();
    updateSelectionAlert();
}

// Platform selection
function selectPlatform(platform) {
    const userTier = safeStorage.getItem('checkreel_tier') || 'free';
    const platformElement = document.querySelector(`[data-platform="${platform}"]`);
    
    if (userTier === 'premium') {
        if (selectedPlatforms.includes(platform)) {
            selectedPlatforms = selectedPlatforms.filter(p => p !== platform);
            platformElement.classList.remove('selected');
        } else {
            if (selectedPlatforms.length < 3) {
                selectedPlatforms.push(platform);
                platformElement.classList.add('selected');
            } else {
                alert('Premium users can select up to 3 platforms per scan');
            }
        }
    } else {
        selectedPlatforms = [platform];
        document.querySelectorAll('.platform-option').forEach(opt => opt.classList.remove('selected'));
        platformElement.classList.add('selected');
    }
    
    updatePlatformCounter();
    updateScanButton();
    updateSelectionAlert();
}

// Update platform counter
function updatePlatformCounter() {
    const counterEl = document.getElementById("platformCounter");
    const userTier = safeStorage.getItem('checkreel_tier') || 'free';
    
    if (userTier === "premium" && counterEl) {
        counterEl.textContent = `(${selectedPlatforms.length}/3 selected)`;
    } else if (counterEl) {
        counterEl.textContent = '';
    }
}

// Countries modal functions
function showCountries(region) {
    const modal = document.getElementById('countriesModal');
    const grid = document.getElementById('countriesGrid');
    const title = document.getElementById('modalTitle');
    title.textContent = `Select Country - ${region.charAt(0).toUpperCase() + region.slice(1)}`;
    grid.innerHTML = '';
    
    countriesData[region].forEach(country => {
        const item = document.createElement('div');
        item.className = 'country-item';
        item.textContent = country;
        item.onclick = () => selectCountry(country);
        grid.appendChild(item);
    });
    
    modal.style.display = 'block';
}

function selectCountry(country) {
    selectedCountry = country;
    closeCountriesModal();
}

function closeCountriesModal() {
    document.getElementById('countriesModal').style.display = 'none';
}

// Update selection alert
function updateSelectionAlert() {
    const alert = document.getElementById('selectionAlert');
    if (selectedRegion && selectedPlatforms.length > 0) {
        alert.classList.add('hidden');
    } else {
        alert.classList.remove('hidden');
    }
}

// File upload functionality
function initializeUpload() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const removeFileBtn = document.getElementById('removeFile');
    
    if (!uploadArea || !fileInput) return;
    
    uploadArea.addEventListener('click', () => {
        if (!selectedRegion || selectedPlatforms.length === 0) {
            const translations = DASHBOARD_TRANSLATIONS[currentLanguage] || DASHBOARD_TRANSLATIONS['en'];
            alert(translations['selection-alert']);
            return;
        }
        fileInput.click();
    });
    
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && selectedRegion && selectedPlatforms.length > 0) {
            handleFileSelect(file);
        }
    });
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (selectedRegion && selectedPlatforms.length > 0) {
            uploadArea.classList.add('dragover');
        }
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (!selectedRegion || selectedPlatforms.length === 0) {
            const translations = DASHBOARD_TRANSLATIONS[currentLanguage] || DASHBOARD_TRANSLATIONS['en'];
            alert(translations['selection-alert']);
            return;
        }
        const file = e.dataTransfer.files[0];
        if (file) {
            handleFileSelect(file);
        }
    });
    
    if (removeFileBtn) {
        removeFileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            clearSelectedFile();
        });
    }
}

function handleFileSelect(file) {
    const allowedTypes = ['video/mp4', 'video/quicktime', 'image/jpeg', 'image/png', 'audio/mp3', 'audio/wav'];
    if (!allowedTypes.includes(file.type)) {
        alert('Unsupported file type. Please select MP4, MOV, JPG, PNG, MP3, or WAV files.');
        return;
    }
    
    const maxSize = 100 * 1024 * 1024;
    if (file.size > maxSize) {
        alert('File size too large. Please select a file smaller than 100MB.');
        return;
    }
    
    selectedFile = file;
    displayFileInfo(file);
    updateScanButton();
}

function displayFileInfo(file) {
    const uploadArea = document.getElementById('uploadArea');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    
    if (fileName) fileName.textContent = file.name;
    if (fileSize) fileSize.textContent = formatFileSize(file.size);
    if (uploadArea) uploadArea.style.display = 'none';
    if (fileInfo) fileInfo.style.display = 'block';
}

function clearSelectedFile() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInfo = document.getElementById('fileInfo');
    const fileInput = document.getElementById('fileInput');
    
    selectedFile = null;
    if (fileInput) fileInput.value = '';
    if (uploadArea) uploadArea.style.display = 'block';
    if (fileInfo) fileInfo.style.display = 'none';
    updateScanButton();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function updateScanButton() {
    const scanBtn = document.getElementById('scanBtn');
    if (!scanBtn) return;
    
    const canScan = selectedFile && selectedPlatforms.length > 0 && selectedRegion;
    scanBtn.disabled = !canScan;
    
    if (canScan) {
        scanBtn.classList.add('ready');
    } else {
        scanBtn.classList.remove('ready');
    }
}

// Scan functionality
const scanBtn = document.getElementById('scanBtn');
if (scanBtn) {
    scanBtn.addEventListener('click', async function() {
        if (!selectedFile || selectedPlatforms.length === 0 || !selectedRegion) return;
        
        if (!checkScanLimit()) {
            alert('You have reached your scan limit! Please upgrade your plan.');
            return;
        }
        
        await performScan();
    });
}

function checkScanLimit() {
    const userTier = safeStorage.getItem('checkreel_tier') || 'free';
    const scansUsed = parseInt(safeStorage.getItem('checkreel_scans_used') || '0');
    const limits = {
        free: 3,
        plus: 20,
        premium: 40
    };
    return scansUsed < limits[userTier];
}

async function performScan() {
    const scanBtn = document.getElementById('scanBtn');
    const btnText = document.getElementById('start-check');
    const btnLoader = document.getElementById('btnLoader');
    const resultsSection = document.getElementById('resultsSection');
    
    if (!scanBtn) return;
    
    const translations = DASHBOARD_TRANSLATIONS[currentLanguage] || DASHBOARD_TRANSLATIONS['en'];
    
    scanBtn.disabled = true;
    if (btnText) btnText.textContent = translations['analyzing'];
    if (btnLoader) btnLoader.classList.add('active');
    
    try {
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        const results = generateDynamicResults();
        displayResults(results);
        saveScanToHistory(results);
        incrementScanCount();
        updateTierDisplay();
        updateScansCounter();
        
        if (resultsSection) {
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
    } catch (error) {
        console.error('Scan error:', error);
        alert('An error occurred during scanning. Please try again.');
    } finally {
        scanBtn.disabled = false;
        if (btnText) btnText.textContent = translations['start-check'];
        if (btnLoader) btnLoader.classList.remove('active');
    }
}

function generateDynamicResults() {
    const userTier = safeStorage.getItem('checkreel_tier') || 'free';
    const scenarios = [
        { score: 95, issueCount: 0 },
        { score: 85, issueCount: 2 },
        { score: 70, issueCount: 4 },
        { score: 55, issueCount: 6 },
        { score: 40, issueCount: 8 }
    ];
    
    const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
    let issues, recommendations, status, statusIcon;
    
    if (scenario.score >= 90) {
        status = 'Perfect! Ready to Post';
        statusIcon = '✅';
    } else if (scenario.score >= 80) {
        status = 'Good to Post';
        statusIcon = '✅';
    } else if (scenario.score >= 70) {
        status = 'Minor Issues - Review Recommended';
        statusIcon = '⚠️';
    } else if (scenario.score >= 60) {
        status = 'Moderate Issues - Fix Before Posting';
        statusIcon = '⚠️';
    } else {
        status = 'Major Issues - Do Not Post';
        statusIcon = '❌';
    }
    
    if (userTier === 'free') {
        issues = scenario.issueCount > 0 ? [
            { icon: '⚠️', text: `${scenario.issueCount} compliance issues detected for ${selectedPlatforms.join(', ')}` }
        ] : [];
        recommendations = [
            { icon: '💡', text: `Upgrade to Plus or Premium for detailed analysis` }
        ];
    } else if (userTier === 'plus') {
        issues = scenario.issueCount > 0 ? [
            { icon: '🔊', text: `Audio levels exceed ${selectedPlatforms.join(', ')} limits` },
            { icon: '📋', text: `Content may violate ${selectedRegion} community guidelines` }
        ].slice(0, Math.min(scenario.issueCount, 2)) : [];
        recommendations = [
            { icon: '📈', text: `Use trending hashtags for ${selectedPlatforms.join(', ')}` },
            { icon: '⏰', text: `Best posting time for ${selectedRegion}: 7-9 PM local` }
        ];
    } else {
        issues = scenario.issueCount > 0 ? [
            { icon: '🎵', text: `Audio enhancement needed - our AI recommends voice optimization` },
            { icon: '📹', text: `Visual quality below platform standards` },
            { icon: '⏱️', text: `Video pacing needs adjustment for ${selectedPlatforms.join(', ')}` }
        ].slice(0, Math.min(scenario.issueCount, 3)) : [];
        recommendations = [
            { icon: '🧠', text: `AI Analysis: Adjust content pacing for better engagement` },
            { icon: '🎯', text: `Optimization tip: Add stronger hooks in first 3 seconds` },
            { icon: '⭐', text: `Our advanced AI suggests format adjustments for viral potential` }
        ];
    }
    
    return {
        score: scenario.score,
        status: status,
        statusIcon: statusIcon,
        issues: issues,
        recommendations: recommendations,
        platforms: selectedPlatforms,
        region: selectedRegion
    };
}

function displayResults(results) {
    const resultsSection = document.getElementById('resultsSection');
    const scoreValue = document.getElementById('scoreValue');
    const statusText = document.getElementById('status-text');
    const statusIcon = document.getElementById('statusIcon');
    const issuesList = document.getElementById('issuesList');
    const recommendationsList = document.getElementById('recommendationsList');
    const scoreCircle = document.getElementById('scoreCircle');
    
    if (scoreValue) scoreValue.textContent = results.score;
    if (scoreCircle) {
        const red = results.score < 50 ? 255 : Math.round(255 * (100 - results.score) / 50);
        const green = results.score > 50 ? 255 : Math.round(255 * results.score / 50);
        const gradient = `conic-gradient(from 0deg, 
            rgb(${red}, ${green}, 0) 0%, 
            rgb(${red}, ${green}, 0) ${results.score}%, 
            #e0e0e0 ${results.score}%)`;
        scoreCircle.style.background = gradient;
    }
    
    if (statusText) statusText.textContent = results.status;
    if (statusIcon) statusIcon.textContent = results.statusIcon;
    
    if (issuesList) {
        issuesList.innerHTML = '';
        results.issues.forEach((issue, index) => {
            const item = document.createElement('div');
            item.className = 'issue-item';
            item.innerHTML = `
                <span class="issue-icon">${issue.icon}</span>
                <span>${issue.text}</span>
            `;
            item.onclick = () => showInsight('issue', issue, index);
            issuesList.appendChild(item);
        });
    }
    
    if (recommendationsList) {
        recommendationsList.innerHTML = '';
        results.recommendations.forEach((rec, index) => {
            const item = document.createElement('div');
            item.className = 'recommendation-item';
            item.innerHTML = `
                <span class="recommendation-icon">${rec.icon}</span>
                <span>${rec.text}</span>
            `;
            item.onclick = () => showInsight('recommendation', rec, index);
            recommendationsList.appendChild(item);
        });
    }
    
    if (resultsSection) resultsSection.style.display = 'block';
}

function showInsight(type, item, index) {
    const modal = document.getElementById('insightModal');
    const title = document.getElementById('insightTitle');
    const content = document.getElementById('insightContent');
    
    title.textContent = type === 'issue' ? 'Issue Details' : 'Recommendation Details';
    
    const userTier = safeStorage.getItem('checkreel_tier') || 'free';
    let detailedContent = '';
    
    if (userTier === 'premium' && type === 'recommendation') {
        detailedContent = `
            <p><strong>Detailed Analysis:</strong></p>
            <p>${item.text}</p>
            <br>
            <p><strong>AI-Powered Recommendations:</strong></p>
            <ul>
                <li>🎨 <strong>Visual Enhancement:</strong> Our advanced AI suggests improving graphics and thumbnails for better engagement</li>
                <li>⭐ <strong>Audio Optimization:</strong> AI-powered voice enhancement can improve audio quality by 40%</li>
                <li>🎬 <strong>Video Effects:</strong> Smart transitions and effects recommended for viral potential</li>
                <li>⚙️ <strong>Content Processing:</strong> Advanced optimization for maximum platform compatibility</li>
            </ul>
            <br>
            <p><strong>Note:</strong> Our system uses cutting-edge AI technology to provide these insights, ensuring your content performs at its best.</p>
        `;
    } else {
        detailedContent = `
            <p><strong>Details:</strong></p>
            <p>${item.text}</p>
            <br>
            <p>Upgrade to Premium for advanced AI-powered recommendations and detailed optimization insights.</p>
        `;
    }
    
    content.innerHTML = detailedContent;
    modal.style.display = 'block';
}

function closeInsightModal() {
    document.getElementById('insightModal').style.display = 'none';
}

// Scan History Functions
function saveScanToHistory(results) {
    const userTier = safeStorage.getItem('checkreel_tier') || 'free';
    if (userTier === 'free') return;
    
    const scan = {
        id: Date.now(),
        date: new Date().toISOString(),
        score: results.score,
        status: results.status,
        platforms: results.platforms,
        region: results.region,
        fileName: selectedFile.name
    };
    
    let history = JSON.parse(safeStorage.getItem('checkreel_scan_history') || '[]');
    history.unshift(scan);
    
    if (history.length > 50) {
        history = history.slice(0, 50);
    }
    
    safeStorage.setItem('checkreel_scan_history', JSON.stringify(history));
    loadScanHistory();
}

function loadScanHistory() {
    const userTier = safeStorage.getItem('checkreel_tier') || 'free';
    if (userTier === 'free') return;
    
    scanHistory = JSON.parse(safeStorage.getItem('checkreel_scan_history') || '[]');
    displayHistory('all');
}

function displayHistory(filter) {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    
    let filteredHistory = scanHistory;
    
    historyList.innerHTML = '';
    filteredHistory.forEach(scan => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
            <div>
                <strong>${scan.fileName}</strong><br>
                <span style="font-size: 12px; color: #666;">
                    ${scan.platforms.join(', ')} | ${scan.region} | Score: ${scan.score}
                </span>
            </div>
            <div>
                <span class="history-date">${new Date(scan.date).toLocaleDateString()}</span>
            </div>
        `;
        item.onclick = () => viewHistoryScan(scan);
        historyList.appendChild(item);
    });
}

function filterHistory(type) {
    document.querySelectorAll('.history-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    if (type === 'region') {
        const grouped = {};
        scanHistory.forEach(scan => {
            if (!grouped[scan.region]) grouped[scan.region] = [];
            grouped[scan.region].push(scan);
        });
        displayGroupedHistory(grouped, 'region');
    } else if (type === 'platform') {
        const grouped = {};
        scanHistory.forEach(scan => {
            scan.platforms.forEach(platform => {
                if (!grouped[platform]) grouped[platform] = [];
                grouped[platform].push(scan);
            });
        });
        displayGroupedHistory(grouped, 'platform');
    } else {
        displayHistory('all');
    }
}

function displayGroupedHistory(grouped, type) {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    
    historyList.innerHTML = '';
    Object.keys(grouped).forEach(key => {
        const header = document.createElement('h4');
        header.style.cssText = 'margin: 15px 0 10px; color: #1e3c72; text-transform: capitalize;';
        header.textContent = key;
        historyList.appendChild(header);
        
        grouped[key].forEach(scan => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <div>
                    <strong>${scan.fileName}</strong><br>
                    <span style="font-size: 12px; color: #666;">Score: ${scan.score}</span>
                </div>
                <div>
                    <span class="history-date">${new Date(scan.date).toLocaleDateString()}</span>
                </div>
            `;
            item.onclick = () => viewHistoryScan(scan);
            historyList.appendChild(item);
        });
    });
}

function viewHistoryScan(scan) {
    alert(`Viewing scan: ${scan.fileName}\nScore: ${scan.score}\nStatus: ${scan.status}`);
}

function incrementScanCount() {
    const currentCount = parseInt(safeStorage.getItem('checkreel_scans_used') || '0');
    safeStorage.setItem('checkreel_scans_used', (currentCount + 1).toString());
}

// Tier management
function updateTierDisplay() {
    const userTier = safeStorage.getItem('checkreel_tier') || 'free';
    const scansUsed = parseInt(safeStorage.getItem('checkreel_scans_used') || '0');
    const tierData = {
        free: { name: 'Free Trial', scans: 3, class: 'tier-free' },
        plus: { name: 'Plus', scans: 20, class: 'tier-plus' },
        premium: { name: 'Premium', scans: 40, class: 'tier-premium' }
    };
    
    const translations = DASHBOARD_TRANSLATIONS[currentLanguage] || DASHBOARD_TRANSLATIONS['en'];
    const tierNames = {
        free: translations['free-trial'],
        plus: translations['plus-tier'],
        premium: translations['premium-tier']
    };
    
    const tier = tierData[userTier];
    const scansLeft = Math.max(0, tier.scans - scansUsed);
    const tierBadge = document.getElementById('tierBadge');
    const scansLeftEl = document.getElementById('scansLeft');
    
    if (tierBadge) {
        tierBadge.textContent = tierNames[userTier] || tier.name;
        tierBadge.className = `tier-badge ${tier.class}`;
    }
    
    if (scansLeftEl) {
        scansLeftEl.textContent = `${scansLeft} ${translations['scans-left']}`;
    }
}

function updateUserCounter() {
    const baseCount = 2697;
    let userIncrement = safeStorage.getItem('checkreel_user_increment');
    if (!userIncrement) {
        userIncrement = Math.floor(Math.random() * 100) + 1;
        safeStorage.setItem('checkreel_user_increment', userIncrement.toString());
    }
    const totalUsers = baseCount + parseInt(userIncrement);
    
    const statCards = document.querySelectorAll('.stat-number');
    if (statCards[0]) {
        statCards[0].textContent = `${totalUsers.toLocaleString()}+`;
    }
}

function updateScansCounter() {
    const scansUsed = parseInt(safeStorage.getItem('checkreel_scans_used') || '0');
    const counterEl = document.getElementById('scansUsedCounter');
    if (counterEl) {
        counterEl.textContent = scansUsed;
    }
}

// Make functions globally available
window.selectTier = selectTier;
window.selectRegion = selectRegion;
window.selectPlatform = selectPlatform;
window.showCountries = showCountries;
window.closeCountriesModal = closeCountriesModal;
window.selectCountry = selectCountry;
window.showInsight = showInsight;
window.closeInsightModal = closeInsightModal;
window.filterHistory = filterHistory;

// Close modals when clicking outside
window.addEventListener('click', function(e) {
    const countriesModal = document.getElementById('countriesModal');
    const insightModal = document.getElementById('insightModal');
    if (e.target === countriesModal) {
        closeCountriesModal();
    }
    if (e.target === insightModal) {
        closeInsightModal();
    }
});
</script>
</body>
</html>