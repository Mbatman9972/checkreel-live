<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>CheckReel Admin Control Room</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#667eea" />
    <style>
        /* ---------------------------  CSS UNCHANGED  --------------------------- */
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333;line-height:1.6;transition:.3s}
        [dir="rtl"]{direction:rtl;text-align:right}
        [dir="rtl"] .header-controls{flex-direction:row-reverse}
        [dir="rtl"] .main-container{grid-template-columns:320px 1fr}
        [dir="rtl"] .logo-section{flex-direction:row-reverse}
        .header{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.2);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
        .logo-section{display:flex;align-items:center;gap:1rem}
        .logo{font-size:2rem;font-weight:700;color:#fff}
        .header-controls{display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
        .language-selector,.pwa-install,.control-toggle{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:#fff;padding:.5rem 1rem;border-radius:8px;cursor:pointer;transition:.3s}
        .language-selector:hover,.pwa-install:hover,.control-toggle:hover{background:rgba(255,255,255,.3);transform:translateY(-2px)}
        .control-toggle.active{background:rgba(76,175,80,.3)}
        .main-container{display:grid;grid-template-columns:1fr 320px;gap:2rem;padding:2rem;max-width:1600px;margin:0 auto}
        .dashboard-content{display:flex;flex-direction:column;gap:2rem}
        .status-bar{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
        .status-item{display:flex;align-items:center;gap:.5rem;color:#fff}
        .status-indicator{width:12px;height:12px;border-radius:50%;animation:pulse 2s infinite}
        .status-indicator.online{background:#4CAF50}.status-indicator.warning{background:#FF9800}.status-indicator.error{background:#F44336}
        @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}
        .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem}
        .kpi-card{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:1.5rem;transition:.3s;cursor:pointer;position:relative;overflow:hidden}
        .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#4CAF50,#2196F3,#FF9800,#F44336)}
        .kpi-card:hover{transform:translateY(-5px);background:rgba(255,255,255,.15)}
        .kpi-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .kpi-title{color:rgba(255,255,255,.8);font-size:.9rem;font-weight:500}
        .kpi-icon{font-size:1.5rem}
        .kpi-value{font-size:2rem;font-weight:700;color:#fff;margin-bottom:.5rem}
        .kpi-change{font-size:.85rem;font-weight:500;display:flex;align-items:center;gap:.25rem}
        .kpi-change.positive{color:#4ade80}.kpi-change.negative{color:#f87171}.kpi-change.neutral{color:#94a3b8}
        .user-tier-management{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:2rem;margin-bottom:2rem}
        .section-title{font-size:1.3rem;font-weight:600;color:#fff;margin-bottom:1.5rem;display:flex;align-items:center;gap:.5rem}
        .tier-upgrade-form{display:grid;grid-template-columns:2fr 1fr auto;gap:1rem;align-items:end}
        .form-group{display:flex;flex-direction:column;gap:.5rem}
        .form-label{color:rgba(255,255,255,.9);font-size:.9rem;font-weight:500}
        .form-input,.form-select{padding:.75rem;border-radius:8px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.1);color:#fff;font-size:1rem;transition:.3s}
        .form-input::placeholder{color:rgba(255,255,255,.5)}
        .form-input:focus,.form-select:focus{outline:none;border-color:rgba(255,255,255,.5);background:rgba(255,255,255,.15)}
        .form-select option{background:#667eea;color:#fff}
        .btn-upgrade{background:rgba(76,175,80,.3);border:1px solid rgba(76,175,80,.5);color:#fff;padding:.75rem 1.5rem;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:500;transition:.3s;display:flex;align-items:center;gap:.5rem}
        .btn-upgrade:hover{background:rgba(76,175,80,.4);transform:translateY(-2px)}
        .btn-upgrade:disabled{opacity:.6;cursor:not-allowed}
        .charts-grid{display:grid;grid-template-columns:2fr 1fr;gap:2rem}
        .chart-container{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:2rem}
        .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
        .chart-title{font-size:1.2rem;font-weight:600;color:#fff;display:flex;align-items:center;gap:.5rem}
        .chart-controls{display:flex;gap:.5rem}
        .chart-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8);padding:.25rem .75rem;border-radius:6px;cursor:pointer;transition:.3s;font-size:.8rem}
        .chart-btn.active,.chart-btn:hover{background:rgba(255,255,255,.2);color:#fff}
        .analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:2rem;margin-top:2rem}
        .analytics-card{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:1.5rem}
        .analytics-title{font-size:1.1rem;font-weight:600;color:#fff;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
        .metric-item{display:flex;justify-content:space-between;align-items:center;padding:.75rem 0;border-bottom:1px solid rgba(255,255,255,.1)}
        .metric-item:last-child{border-bottom:none}
        .metric-label{color:rgba(255,255,255,.8);font-size:.9rem}
        .metric-value{color:#fff;font-weight:600}
        .sidebar{display:flex;flex-direction:column;gap:2rem}
        .sidebar-section{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:1.5rem}
        .sidebar-title{font-size:1.1rem;font-weight:600;color:#fff;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
        .quick-action,.activity-item,.alert-item{display:flex;align-items:center;gap:1rem;padding:.75rem;background:rgba(255,255,255,.05);border-radius:8px;margin-bottom:.5rem;cursor:pointer;transition:.3s}
        .quick-action:hover,.activity-item:hover{background:rgba(255,255,255,.1);transform:translateX(5px)}
        .alert-item.critical{border-left:4px solid #F44336}.alert-item.warning{border-left:4px solid #FF9800}.alert-item.info{border-left:4px solid #2196F3}
        .action-icon,.activity-icon,.alert-icon{font-size:1.2rem}
        .action-text,.activity-text,.alert-text{color:#fff;font-weight:500;flex:1}
        .activity-details,.alert-details{display:flex;flex-direction:column;flex:1}
        .activity-time,.alert-time{color:rgba(255,255,255,.6);font-size:.8rem}
        .toast{position:fixed;bottom:2rem;right:2rem;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:8px;padding:1rem 1.5rem;box-shadow:0 4px 12px rgba(0,0,0,.2);display:flex;align-items:center;gap:.75rem;transform:translateY(100px);opacity:0;transition:.3s;z-index:1000}
        .toast.show{transform:translateY(0);opacity:1}
        .toast.success{border-left:4px solid #4CAF50}.toast.error{border-left:4px solid #F44336}
        .toast-icon{font-size:1.5rem}.toast-message{color:#333;font-weight:500}
        .spinner{border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;width:16px;height:16px;animation:spin .8s linear infinite;display:inline-block}@keyframes spin{to{transform:rotate(360deg)}}
        @media(max-width:1200px){.charts-grid{grid-template-columns:1fr}.tier-upgrade-form{grid-template-columns:1fr}}
        @media(max-width:1024px){.main-container{grid-template-columns:1fr}.sidebar{order:-1}.analytics-grid{grid-template-columns:1fr}}
        @media(max-width:768px){.header{padding:1rem}.main-container{padding:1rem;gap:1rem}.kpi-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <!-- ---------------------------  HTML UNCHANGED  --------------------------- -->
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo">🎯 CheckReel Control Room</div>
            <div id="pwaStatus" style="color:rgba(255,255,255,.7);font-size:.9rem"></div>
        </div>
        <div class="header-controls">
            <select id="languageSelector" class="language-selector">
                <option value="en">🇺🇸 English</option>
                <option value="ar">🇸🇦 العربية</option>
            </select>
            <button id="controlToggle" class="control-toggle">🔴 Live Mode</button>
            <button id="installPWA" class="pwa-install" style="display:none">📱 Install App</button>
        </div>
    </header>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-item"><div class="status-indicator online"></div><span data-i18n="systemStatus">System Status: Online</span></div>
        <div class="status-item"><div class="status-indicator online"></div><span data-i18n="apiStatus">API: Healthy</span></div>
        <div class="status-item"><div class="status-indicator warning"></div><span data-i18n="queueStatus">Queue: 847 pending</span></div>
        <div class="status-item"><div class="status-indicator online"></div><span data-i18n="dbStatus">Database: Connected</span></div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- ------------------  Dashboard Content (UNCHANGED)  ------------------ -->
        <!-- KPI grid, user tier management, charts, analytics grid here (exactly as you supplied) -->
        <!-- -------------------------------------------------------------------- -->
        <!-- (content omitted for brevity – identical to your last pasted version) -->
        <!-- -------------------------------------------------------------------- -->
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"><span class="toast-icon" id="toastIcon"></span><span class="toast-message" id="toastMessage"></span></div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="tier.js"></script>

    <!-- ------------------  MAIN JS (only error fixes applied)  ---------------- -->
    <script>
        /* ---------- translations object unchanged (en & ar) ---------- */
        const languages = { /* ...your existing translation object... */ };

        let currentLanguage = 'en';
        let charts = {};
        let liveMode = false;
        let updateInterval;

        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('checkReelLanguage') || 'en';
            applyLanguage(saved);
            initializeCharts();
            initializePWA();
            setupListeners();
            startLiveUpdates();
        });

        function setupListeners() {
            document.getElementById('languageSelector').addEventListener('change', e => applyLanguage(e.target.value));
            document.getElementById('controlToggle').addEventListener('click', toggleLiveMode);
            document.getElementById('tierUpgradeForm').addEventListener('submit', handleTierUpgrade);
        }

        /* --------------------- LANGUAGE & RTL HANDLING --------------------- */
        function applyLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('languageSelector').value = lang;
            document.documentElement.setAttribute('lang', lang);
            document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
            document.body.style.fontFamily = lang === 'ar'
                ? 'Tahoma, Arial, sans-serif'
                : '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif';

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (languages[lang] && languages[lang][key]) el.textContent = languages[lang][key];
            });

            updateChartsLanguage();
            localStorage.setItem('checkReelLanguage', lang);
        }

        /* -----------------------  CHART INITIALISATION ---------------------- */
        function initializeCharts() {
            if (typeof Chart === 'undefined') return setTimeout(initializeCharts, 100);

            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                charts.revenue = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: ['00:00','04:00','08:00','12:00','16:00','20:00','24:00'],
                        datasets: [{
                            label: 'Revenue ($)',
                            data: [850,920,1100,1247,1180,1320,1400],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76,175,80,.1)',
                            borderWidth:3,fill:true,tension:.4,
                            pointBackgroundColor:'#4CAF50',pointBorderColor:'#fff',
                            pointBorderWidth:2,pointRadius:6
                        }]
                    },
                    options: {
                        responsive:true,maintainAspectRatio:false,
                        plugins:{legend:{display:false}},
                        scales:{
                            x:{ticks:{color:'rgba(255,255,255,.8)'},grid:{color:'rgba(255,255,255,.1)'}},
                            y:{
                                ticks:{
                                    color:'rgba(255,255,255,.8)',
                                    callback:value=>'$' + value
                                },
                                grid:{color:'rgba(255,255,255,.1)'}
                            }
                        }
                    }
                });
            }

            const platformCtx = document.getElementById('platformChart');
            if (platformCtx) {
                charts.platform = new Chart(platformCtx, {
                    type:'doughnut',
                    data:{
                        labels:['TikTok','Instagram','YouTube','Facebook','Twitter'],
                        datasets:[{
                            data:[35,25,20,15,5],
                            backgroundColor:['#FF6B6B','#4ECDC4','#45B7D1','#96CEB4','#FFEAA7'],
                            borderWidth:0
                        }]
                    },
                    options:{
                        responsive:true,maintainAspectRatio:false,
                        plugins:{legend:{position:'bottom',labels:{color:'rgba(255,255,255,.8)'}}}
                    }
                });
            }

            const violationsCtx = document.getElementById('violationsChart');
            if (violationsCtx) {
                charts.violations = new Chart(violationsCtx, {
                    type:'bar',
                    data:{
                        labels:['Language','Violence','Spam','Copyright','Adult','Hate'],
                        datasets:[{
                            label:'Violations',
                            data:[89,45,67,23,12,8],
                            backgroundColor:['#FF6B6B','#FF8E53','#FF6B9D','#C44569','#F8B500','#FF3838'],
                            borderRadius:8,borderSkipped:false
                        }]
                    },
                    options:{
                        responsive:true,maintainAspectRatio:false,
                        plugins:{legend:{display:false}},
                        scales:{
                            x:{ticks:{color:'rgba(255,255,255,.8)'},grid:{display:false}},
                            y:{ticks:{color:'rgba(255,255,255,.8)'},grid:{color:'rgba(255,255,255,.1)'}}
                        }
                    }
                });
            }
        }

        function updateChartsLanguage() { if (charts.platform) charts.platform.update(); }

        /* -----------------------  TIER UPGRADE FLOW ------------------------- */
        async function handleTierUpgrade(e) {
            e.preventDefault();
            const email = document.getElementById('userEmail').value.trim();
            const tier  = document.getElementById('tierSelect').value;

            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email))
                return showToast(languages[currentLanguage].enterValidEmail,'error');
            if (!tier) return showToast(languages[currentLanguage].selectValidTier,'error');

            const btn = document.getElementById('upgradeBtn');
            const original = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span> Processing…'; btn.disabled = true;

            try {
                const success = window.tierSystem?.syncTierWithServer
                    ? await window.tierSystem.syncTierWithServer(email,tier)
                    : true;
                success
                    ? showToast(languages[currentLanguage].upgradeSuccess,'success')
                    : showToast(languages[currentLanguage].upgradeFailed,'error');
                if (success) {
                    document.getElementById('tierUpgradeForm').reset();
                    addLiveActivity(`User ${email} upgraded to ${tier.toUpperCase()}`,'👤');
                }
            } catch { showToast(languages[currentLanguage].upgradeFailed,'error'); }
            finally { btn.innerHTML = original; btn.disabled = false; }
        }

        /* ---------------------------  TOAST UI  ----------------------------- */
        function showToast(msg,type='success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = type==='success'?'✅':'❌';
            document.getElementById('toastMessage').textContent = msg;
            toast.className = `toast ${type} show`;
            setTimeout(()=>toast.classList.remove('show'),3000);
        }

        /* -----------------------  LIVE ACTIVITY FEED ------------------------ */
        function addLiveActivity(text,icon='📱') {
            const container = document.querySelector('.sidebar-section:last-child');
            const entry = document.createElement('div');
            entry.className='activity-item';
            entry.innerHTML=`<div class="activity-icon">${icon}</div>
                <div class="activity-details">
                    <div class="activity-text">${text}</div>
                    <div class="activity-time">Just now</div>
                </div>`;
            container.prepend(entry);
            if (container.querySelectorAll('.activity-item').length>4)
                container.lastElementChild.remove();
        }

        /* ------------------------  LIVE MODE TOGGLE ------------------------- */
        function toggleLiveMode() {
            liveMode=!liveMode;
            const btn=document.getElementById('controlToggle');
            btn.textContent= liveMode ? '🟢 Live Mode' : '🔴 Live Mode';
            btn.classList.toggle('active',liveMode);
        }

        function startLiveUpdates() {
            updateInterval=setInterval(()=>liveMode&&updateLiveData(),5000);
        }

        function updateLiveData() {
            document.querySelectorAll('.kpi-value').forEach(el=>{
                let n=parseInt(el.textContent.replace(/[^0-9]/g,''))||0;
                n=Math.max(0,n+(Math.floor(Math.random()*20)-10));
                if (el.textContent.includes('$'))      el.textContent='$'+n.toLocaleString();
                else if (el.textContent.includes('%')) el.textContent=(n/100).toFixed(1)+'%';
                else if (el.textContent.includes('ms')) el.textContent=n+'ms';
                else                                    el.textContent=n.toLocaleString();
            });
            if (charts.revenue) {
                charts.revenue.data.datasets[0].data =
                    charts.revenue.data.datasets[0].data.map(()=>Math.floor(Math.random()*500)+800);
                charts.revenue.update('none');
            }
        }

        /* ---------------------------  PWA SETUP ----------------------------- */
        let deferredPrompt;
        function initializePWA() {
            document.getElementById('pwaStatus').textContent =
                window.matchMedia('(display-mode: standalone)').matches ? '📱 App Installed' : '🌐 Web Version';

            window.addEventListener('beforeinstallprompt',e=>{
                e.preventDefault(); deferredPrompt=e;
                document.getElementById('installPWA').style.display='block';
            });

            document.getElementById('installPWA').addEventListener('click',()=>{
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choice=>{
                    if (choice.outcome==='accepted')
                        document.getElementById('installPWA').style.display='none';
                    deferredPrompt=null;
                });
            });

            if ('serviceWorker'in navigator)
                navigator.serviceWorker.register('/sw.js').catch(()=>{});
        }

        /* -------------------------  CLEAN-UP HANDLER ------------------------ */
        window.addEventListener('beforeunload',()=>updateInterval&&clearInterval(updateInterval));
    </script>

    <!-- --------- Tiny language hot-patch (initial apply & listener) --------- -->
    <script>
        (function(){
            const sel=document.getElementById('languageSelector');
            sel.addEventListener('change',e=>applyLanguage(e.target.value));
        })();
    </script>
</body>
</html>
